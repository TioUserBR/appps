{% extends 'base.html' %}

{% block title %}{% if ordem %}Editar OS {{ ordem.numero }}{% else %}Nova Ordem de Serviço{% endif %} - AM LICITA{% endblock %}

{% block content %}
<div class="form-page">
    <div class="form-header">
        <a href="{{ url_for('index') }}" class="btn-back">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
        <h1>
            <i class="fas fa-{% if ordem %}edit{% else %}plus-circle{% endif %}"></i>
            {% if ordem %}Editar Ordem de Serviço {{ ordem.numero }}{% else %}Nova Ordem de Serviço{% endif %}
        </h1>
    </div>

    <form method="POST" class="ordem-form" id="ordemForm">
        <!-- Dados do Cliente -->
        <div class="form-section">
            <h2><i class="fas fa-user"></i> Dados do Cliente</h2>
            <div class="form-grid">
                <div class="form-group full-width">
                    <label for="cliente">Nome do Cliente *</label>
                    <input type="text" id="cliente" name="cliente" required
                           value="{{ ordem.cliente if ordem else '' }}"
                           placeholder="Nome completo ou razão social">
                </div>
                
                <div class="form-group">
                    <label for="cpf_cnpj">CPF/CNPJ</label>
                    <input type="text" id="cpf_cnpj" name="cpf_cnpj"
                           value="{{ ordem.cpf_cnpj if ordem else '' }}"
                           placeholder="000.000.000-00">
                </div>
                
                <div class="form-group">
                    <label for="telefone">Telefone</label>
                    <input type="text" id="telefone" name="telefone"
                           value="{{ ordem.telefone if ordem else '' }}"
                           placeholder="(00) 00000-0000">
                </div>
                
                <div class="form-group">
                    <label for="email">E-mail</label>
                    <input type="email" id="email" name="email"
                           value="{{ ordem.email if ordem else '' }}"
                           placeholder="email@exemplo.com">
                </div>
                
                <div class="form-group">
                    <label for="cidade">Cidade/UF</label>
                    <input type="text" id="cidade" name="cidade"
                           value="{{ ordem.cidade if ordem else '' }}"
                           placeholder="Cidade - UF">
                </div>
                
                <div class="form-group full-width">
                    <label for="endereco">Endereço Completo</label>
                    <input type="text" id="endereco" name="endereco"
                           value="{{ ordem.endereco if ordem else '' }}"
                           placeholder="Rua, número, bairro, complemento">
                </div>
            </div>
        </div>

        <!-- Itens/Serviços -->
        <div class="form-section">
            <h2><i class="fas fa-list"></i> Itens/Serviços</h2>
            
            <div class="items-header">
                <button type="button" class="btn btn-secondary" id="addItem">
                    <i class="fas fa-plus"></i> Adicionar Item
                </button>
            </div>
            
            <div class="items-table-wrapper">
                <table class="items-table">
                    <thead>
                        <tr>
                            <th class="th-desc">Descrição</th>
                            <th class="th-qty">Qtd</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                        <!-- Itens serão adicionados aqui via JS -->
                    </tbody>
            </div>
            
            <input type="hidden" name="itens_json" id="itensJson">
        </div>

        <!-- Observações -->
        <div class="form-section">
            <h2><i class="fas fa-sticky-note"></i> Observações</h2>
            <div class="form-group">
                <textarea id="observacoes" name="observacoes" rows="4"
                          placeholder="Observações adicionais, condições de pagamento, garantia, etc.">{{ ordem.observacoes if ordem else '' }}</textarea>
            </div>
        </div>

        <!-- Botões -->
        <div class="form-actions">
            <a href="{{ url_for('index') }}" class="btn btn-cancel">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save"></i> {% if ordem %}Atualizar{% else %}Criar{% endif %} Ordem de Serviço
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    let itens = [];
    let itemCounter = 0;

    // Carregar itens existentes (se editando)
    {% if ordem and ordem.itens %}
    itens = [
        {% for item in ordem.itens %}
        {
            id: {{ loop.index }},
            descricao: "{{ item.descricao }}",
            quantidade: {{ item.quantidade }},
            valor_unitario: {{ item.valor_unitario }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    itemCounter = {{ ordem.itens|length }};
    {% endif %}

    function formatarMoeda(valor) {
        return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function renderizarItens() {
        const tbody = document.getElementById('itemsBody');
        tbody.innerHTML = '';
        
        let total = 0;
        
        itens.forEach((item, index) => {
            const subtotal = item.quantidade * item.valor_unitario;
            total += subtotal;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <input type="text" class="item-input item-desc" value="${item.descricao}" 
                           onchange="atualizarItem(${index}, 'descricao', this.value)"
                           placeholder="Descrição do serviço/produto">
                </td>
                <td>
                    <input type="number" class="item-input item-qty" value="${item.quantidade}" 
                           onchange="atualizarItem(${index}, 'quantidade', this.value)"
                           step="0.01" min="0.01">
                </td>
                <td>
                    <input type="number" class="item-input item-price" value="${item.valor_unitario}" 
                           onchange="atualizarItem(${index}, 'valor_unitario', this.value)"
                           step="0.01" min="0">
                </td>
                <td class="item-total">${formatarMoeda(subtotal)}</td>
                <td>
                    <button type="button" class="btn-remove" onclick="removerItem(${index})" title="Remover">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('totalGeral').textContent = formatarMoeda(total);
        document.getElementById('itensJson').value = JSON.stringify(itens);
    }

    function adicionarItem() {
        itemCounter++;
        itens.push({
            id: itemCounter,
            descricao: '',
            quantidade: 1,
            valor_unitario: 0
        });
        renderizarItens();
        
        // Focar no campo de descrição do novo item
        const inputs = document.querySelectorAll('.item-desc');
        if (inputs.length > 0) {
            inputs[inputs.length - 1].focus();
        }
    }

    function atualizarItem(index, campo, valor) {
        if (campo === 'quantidade' || campo === 'valor_unitario') {
            itens[index][campo] = parseFloat(valor) || 0;
        } else {
            itens[index][campo] = valor;
        }
        renderizarItens();
    }

    function removerItem(index) {
        if (itens.length > 1 || confirm('Deseja remover o último item?')) {
            itens.splice(index, 1);
            renderizarItens();
        }
    }

    // Event Listeners
    document.getElementById('addItem').addEventListener('click', adicionarItem);

    document.getElementById('ordemForm').addEventListener('submit', function(e) {
        // Validar se há pelo menos um item com descrição
        const itensValidos = itens.filter(item => item.descricao.trim() !== '');
        if (itensValidos.length === 0) {
            e.preventDefault();
            alert('Adicione pelo menos um item/serviço com descrição.');
            return;
        }
        
        // Atualizar JSON antes de enviar
        document.getElementById('itensJson').value = JSON.stringify(itensValidos);
    });

    // Máscaras de input
    document.getElementById('cpf_cnpj').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 11) {
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        } else {
            value = value.replace(/^(\d{2})(\d)/, '$1.$2');
            value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
            value = value.replace(/(\d{4})(\d)/, '$1-$2');
        }
        e.target.value = value;
    });

    document.getElementById('telefone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 10) {
            value = value.replace(/(\d{2})(\d)/, '($1) $2');
            value = value.replace(/(\d{4})(\d)/, '$1-$2');
        } else {
            value = value.replace(/(\d{2})(\d)/, '($1) $2');
            value = value.replace(/(\d{5})(\d)/, '$1-$2');
        }
        e.target.value = value;
    });

    // Inicialização
    if (itens.length === 0) {
        adicionarItem();
    } else {
        renderizarItens();
    }
</script>

{% endblock %}
